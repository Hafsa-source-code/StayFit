@{
    ViewData["Title"] = "Dashboard";
    var userName = ViewData["UserName"] as string ?? "User";
}

<div class="dashboard-container">

    <aside class="dashboard-sidebar">
        <h3 class="text-center fw-bold">Dashboard</h3>

        <ul class="sidebar-menu">

            <li>
                <a href="#"
                   class="sidebar-link active"
                   data-url="/User/PlanWidgetsPartial">
                    <b>üè† Home</b>
                </a>
            </li>
            <li>
                <a href="#"
                   class="sidebar-link"
                   data-url="/Profile/SetupPartial">
                   <b> üë§ View Profile </b>
                </a>
            </li>
            @if (User.Identity.IsAuthenticated)
            {
                <li>
                    <a href="#" class="sidebar-link" data-url="/User/NotificationsPartial">
                    üîî Notifications
                    <span id="sidebarNotifCount" class="badge bg-danger">0</span>
                </a>
                </li>
            }
            <li>
                <a href="#"
                   class="sidebar-link"
                   data-url="/Goals/SelectGoalPartial">
                   <b> üéØ Edit Goal</b>
                </a>
            </li>
            <li>
                <a href="#"
                   class="sidebar-link"
                   data-url="/User/ProgressTrackerPartial">
                    <b> üìà Progress Tracker</b>
                </a>
            </li>

            <li>
                <a href="#"
                   class="sidebar-link"
                   data-url="/User/FeedbackPartial">
                    <b>üí¨ Feedback</b>
                </a>
            </li>

            <li class="mt-4">
                <form method="post" asp-area="Identity" asp-page="/Account/Logout">
                    <button class="logout-btn w-100">
                      <b>  üö™ Logout </b>
                    </button>
                </form>
            </li>

        </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="dashboard-main">

        <!-- WELCOME -->
        <div class="dashboard-welcome text-center mb-4">
            <h1 class="fw-bold">@userName</h1>
            <p><b>Welcome to your dashboard üëã</b></p>
        </div>

        <!-- DYNAMIC CONTENT -->
        <div id="dashboardContent">
            <p class="text-center">Loading...</p>
        </div>

    </main>
</div>
@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script>
$(function () {

    // Load existing notifications
    $.get("/User/NotificationsPartial", function(html){
        $("#notificationList").html(html);
        $("#sidebarNotifCount").text($("#notificationList li").length);
    });

    loadNotificationCount();

    // Load Home widgets by default
    loadHomeWidgets();

    // Sidebar navigation
    $(".sidebar-link").on("click", function (e) {
        e.preventDefault();

        $(".sidebar-link").removeClass("active");
        $(this).addClass("active");

        const url = $(this).data("url");
        $("#dashboardContent").html("<p class='text-center'>Loading...</p>");
        $("#dashboardContent").load(url, function() {
            bindPartialActions();
        });
    });

    // Load home widgets
    function loadHomeWidgets() {
        $(".sidebar-link").removeClass("active");
        $(".sidebar-link[data-url='/User/PlanWidgetsPartial']").addClass("active");

        $("#dashboardContent").html("<p class='text-center'>Loading...</p>");
        $("#dashboardContent").load("/User/PlanWidgetsPartial", function() {
            bindPartialActions();
        });
    }

    // Load notification count (optional, from DB)
    function loadNotificationCount() {
        $.get("/User/GetNotificationCount", function (count) {
            $("#sidebarNotifCount").text(count);
        });
    }

    // Bind actions inside partials
    function bindPartialActions() {
        // Profile Save
        $("#profileForm").off("submit").on("submit", function(e){
            e.preventDefault();
            const data = {
                UserId: $("input[name='UserId']").val(),
                FullName: $("input[name='FullName']").val(),
                Age: parseInt($("input[name='Age']").val()),
                Weight: parseFloat($("input[name='Weight']").val()),
                Height: parseFloat($("input[name='Height']").val()),
                Gender: $("select[name='Gender']").val(),
                GoalType: $("select[name='GoalType']").val()
            };
            $.ajax({
                url:'/Profile/SaveProfile',
                type:'POST',
                contentType:'application/json',
                data: JSON.stringify(data),
                success:function(res){
                    if(res.success){
                        $("#profileMessage").text(res.message).removeClass('text-danger').addClass('text-success');
                        setTimeout(()=>{ loadHomeWidgets(); }, 800);
                    }
                },
                error:function(){
                    $("#profileMessage").text('Error saving profile').addClass('text-danger');
                }
            });
        });
    }

    // ---------------- SignalR Notifications ----------------
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/notificationsHub")
        .withAutomaticReconnect()
        .build();

    connection.on("ReceiveNotification", function(message) {
        // Add new notification to list
        const li = $("<li>").addClass("list-group-item").text(message);
        $("#notificationList").prepend(li);

        // Increment count
        let count = parseInt($("#sidebarNotifCount").text()) || 0;
        $("#sidebarNotifCount").text(count + 1);
    });

    connection.start().catch(err => console.error(err.toString()));

});
</script>
}
